# Airbnb (Project 5) Notes, Learnings

This Markdown file collates my learnings & insights from building the Airbnb clone.

## Difficulties Encountered

### 1. Including `CSRF Token` in React POST request to Django backend

**Difficulty**

Using Javascript to submit a POST request to the Django backend, I had also included the CSRF Token generated by Django. I set up the following Django view that generates a CSRF Token.

```py
from django.middleware.csrf import get_token

def getCSRFToken(request):
    token = get_token(request)
    return JsonResponse({"token": token}, status=200)
```

The code to submit the POST request is as follows:

```js
async function getCSRFToken() {
  const response = await fetch("http://127.0.0.1:8000/getCSRFToken");
  const jsonResponse = await response.json();
  console.log("CSRFToken: ", jsonResponse["token"]);
  return jsonResponse["token"];
}

async function createListing(listing) {
  let csrftoken;
  getCSRFToken().then((jsonResp) => (csrftoken = jsonResp));
  const response = await fetch(config.backendPort + config.api_createListing, {
    method: "POST",
    body: JSON.stringify(listing),
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken,
    },
  });
  const data = await response.json();
  return data;
}
```

But doing this doesn't seem to work. I am still getting the `Forbidden (CSRF cookie not set.): /createListing` error from Django.

**Resolution**

There are a few things I had mistakenly done:

- The definition of the `getCSRFToken()` view. Returning the token from `get_token()` from the `django.middleware.csrf` library was probably not the best approach. Because calling just the `getCSRFToken()` view, without triggering the `get_token()` function, will return a CSRF Token in the Cookies of the Response.
  I found out about this through Bryan's Part 3 video: [link](https://youtu.be/NFHiT4ncPD8?t=1052).

- Pure JavaScript alone will not be able to retrieve the CSRF Token from the Cookies of the Response. Only AJAX can handle that. Then this is where the custom code (from Django's documentation & several StackOverflow answers) cite the same block of code, to retrieve the cookie `'csrftoken'` from the document.
  I found out about this in Bryan's Part 7 video: [link](https://youtu.be/EMKRnPeiD5A?t=2174).
  This is also mentioned in this StackOverflow answer: [link](https://stackoverflow.com/a/220233/15781733).
