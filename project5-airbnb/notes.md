# Airbnb (Project 5) Notes, Learnings

This Markdown file collates my learnings & insights from building the Airbnb clone.

## Difficulties Encountered

### 1. Including `CSRF Token` in React POST request to Django backend

**Difficulty**

(Part 1)

Using Javascript to submit a POST request to the Django backend, I had also included the CSRF Token generated by Django. I set up the following Django view that generates a CSRF Token.

```py
from django.middleware.csrf import get_token

def getCSRFToken(request):
    token = get_token(request)
    return JsonResponse({"token": token}, status=200)
```

The code to submit the POST request is as follows:

```js
async function getCSRFToken() {
  const response = await fetch("http://127.0.0.1:8000/getCSRFToken");
  const jsonResponse = await response.json();
  console.log("CSRFToken: ", jsonResponse["token"]);
  return jsonResponse["token"];
}

async function createListing(listing) {
  let csrftoken;
  getCSRFToken().then((jsonResp) => (csrftoken = jsonResp));
  const response = await fetch(config.backendPort + config.api_createListing, {
    method: "POST",
    body: JSON.stringify(listing),
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken,
    },
  });
  const data = await response.json();
  return data;
}
```

But doing this doesn't seem to work. I am still getting the `Forbidden (CSRF cookie not set.): /createListing` error from Django.

(Part 2)

Even after using the `axios` package to make the `GET` request to the Django `getCSRFToken/` API endpoint, there is still an issue when making the `POST` request to `createListing/`.

After checking a few SO answers & Bryan's videos, it seems that the initial `GET` request to `getCSRFToken/` doesn't store the cookies in the local browser.

I suspect it's something to do with the CORS setting in Django (`settings.py`).

Better to start from a clean slate & try again.

**Resolution**

There are a few things I had mistakenly done:

- The definition of the `getCSRFToken()` view. Returning the token from `get_token()` from the `django.middleware.csrf` library was probably not the best approach. Because calling just the `getCSRFToken()` view, without triggering the `get_token()` function, will return a CSRF Token in the Cookies of the Response.
  I found out about this through Bryan's Part 3 video: [link](https://youtu.be/NFHiT4ncPD8?t=1052).

- Pure JavaScript alone will not be able to retrieve the CSRF Token from the Cookies of the Response. Only AJAX can handle that. Then this is where the custom code (from Django's documentation & several StackOverflow answers) cite the same block of code, to retrieve the cookie `'csrftoken'` from the document.
  I found out about this in Bryan's Part 7 video: [link](https://youtu.be/EMKRnPeiD5A?t=2174).
  This is also mentioned in this StackOverflow answer: [link](https://stackoverflow.com/a/220233/15781733).
  This StackOverflow post mentions why AJAX is needed to retrieve the HTTP response headers: [link](https://stackoverflow.com/questions/220231/accessing-the-web-pages-http-headers-in-javascript).

- There is also an issue with the `sameSite=Lax` cookie header causing cookies to not be saved in cross-site requests: [link](https://stackoverflow.com/a/72322207/15781733). Setting the following properties in `settings.py` will ensure the `sameSite` cookie header is `None`, [link](https://stackoverflow.com/a/63590219/15781733).

  This Mozilla [documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies) on "Using HTTP Cookies" is useful.

  This website explains how to generate CSRF Tokens (not very in-depth explanation) & custom CSRF Tokens: [link](https://www.makeuseof.com/django-csrf-tokens-what-why-need/).

- That aside, a point to explore is why the the `Set-Cookie` header in the response from the Django backend is not actually setting the cookies in the browser running React.

  Links:

  - [Set cookies for cross-origin requests](https://stackoverflow.com/questions/46288437/set-cookies-for-cross-origin-requests/46412839#46412839)
  - [empty response from rest api using JS, but got a JSON response in PostMan](https://stackoverflow.com/questions/73065409/empty-response-from-rest-api-using-javascript-fetch-method-got-a-json-response)
  - [ensure_csrf_token doesn't set CSRF cookie](https://stackoverflow.com/questions/73860607/ensure-csrf-token-is-not-setting-the-csrf-cookie-in-cookies-tab)
  - [Set-Cookie header not setting cookie in browser](https://stackoverflow.com/questions/61555100/cookie-in-set-cookie-header-not-being-set)
  - [Cookie not set when React & Django on different servers](https://stackoverflow.com/questions/71288955/drf-set-cookie-does-not-work-when-frontend-is-on-localhost-and-backend-is-on-a-r)
  - [Added server address to CORS whitelist, but cross-origin request is blocked](https://stackoverflow.com/questions/71715600/i-have-cors-whitelisted-in-django-and-the-cross-origin-request-is-still-blocked)
  - [Setting up CORS in Django](https://stackoverflow.com/questions/22355540/access-control-allow-origin-in-django-app/67844932#67844932)
  - [CSRF Cookie not set with React frontend -- Django forum](https://forum.djangoproject.com/t/csrf-cookie-is-not-set-with-react-frontend/6509/30)
  - [Django CSRF Token is null in Chrome](https://stackoverflow.com/questions/26049151/django-csrf-token-is-null-in-chrome)

- The following resources are quite extensive on the topic of CORS & cross-site requests:
  - Enabling receiving & sending cookies by a CORS request: [link](https://stackoverflow.com/a/46412839/15781733)
  - Cookie not being set in browser (Django specific): [link](https://stackoverflow.com/a/71309794/15781733)
  - Disabling the `sameSite=Lax` cookie property: [link](https://stackoverflow.com/questions/63576338/django-check-cookiess-samesite-attribute)
  - Django CSRF Protection Guide -- StackHawk: [link](https://www.stackhawk.com/blog/django-csrf-protection-guide/#how-to-use-djangos-csrf-middleware)
  - CSRF Token Missing -- django forums: [link](https://forum.djangoproject.com/t/csrf-token-missing-react-axios-and-django/14169/3)
